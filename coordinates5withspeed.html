<!DOCTYPE>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="coordinateslayout5.css">
		<title>ARPWORLD</title>
		<link rel="shortcut icon" href="/zach/favicon.ico" type="image/x-icon">
		<link rel="icon" href="/favicon.ico" type="image/x-icon">
		<script type="text/javascript">
			var oscisrunning = false;
			var context;
			var osc;
			var oscillator;
			var console;

			function setValues()
			{
				var sqr = document.getElementById('sqr');
				console = document.getElementById('console');
				var x = window.event.clientX - console.offsetLeft;
				var y = (console.offsetTop + console.offsetHeight) - window.event.clientY;
				/*if (x >= (0 + sqr.offsetWidth/2) && x <= (console.offsetWidth - sqr.offsetWidth/2) && 
						y >= (0 + console.offsetTop + sqr.offsetHeight/2) && y <= (console.offsetTop + console.offsetHeight - sqr.offsetWidth/2))
				{
			    	var s = 'X=' + x +  ' Y=' + y + " oT=" + console.offsetTop + " sh/2=" + sqr.offsetHeight/2;
				    sqr.innerText = "";
				    sqr.style.backgroundColor="rgb(" +  window.event.clientX % 255 + ", " + y % 255 + ", " + window.event.clientY % 255 + ")";
				   	// sqr.style.position = "relative";
					sqr.style.left = (x - 50);
					sqr.style.top = (window.event.clientY - 50);
				}*/
				if(x >= (0 + sqr.offsetWidth/2) && x < ((console.offsetWidth - sqr.offsetWidth/2) - 2)) {
					sqr.style.left = (x - 50);
				}
				if (y > (0 + console.offsetTop + sqr.offsetHeight/2) + 2 && y <= (console.offsetTop + console.offsetHeight - sqr.offsetWidth/2)) {
					sqr.style.top = (window.event.clientY - 50);
				}
				else {
					//turnOffOsc();
				}
			};
			function turnOffOsc() 
			{
				if(oscisrunning) {
					oscisrunning = false;
					oscillator.disconnect();
					clearInterval(arp);
				}
			};


		</script>
	</head>
	<body>

		<div id="console" onmousemove="setValues();">
			<div id="sqr"></div>
		</div>

		<aside id="panel">
			<ul>
				<li>ARP?
				<select id="onOff">
					<option value="true">On</option>
					<option value="false">Off</option>
				</select></li>
				<li>WAVEFORM 
				<select id="waveform">
	  				<option value="1">Square</option>
	  				<option value="0">Sine</option>
	  				<option value="2">Saw</option>
	  				<option value="3">Triangle</option>
				</select></li>
				<li>INTERVAL  
				<select id="interval"> 
					<option value="12">Octaves</option>
					<option value="7">Fifths</option>
					<option value="5">Fourths</option>
				</select>
				</li>
				<li>FILTERTYPE
				<select id="filter">
					<option value="0">Lowpass</option>
					<option value="1">Highpass</option>
					<option value="2">Bandpass</option>
					<option value="3">Lowshelf</option>
					<option value="4">Highshelf</option>
					<option value="5">Peaking</option>
					<option value="6">Notch</option>
					<option value="7">Allpass</option>
				</select>
				</li>
				<li>SPEED
				<select id="speed">
					<option value="100">Normal</option>
					<option value="50">Fast</option>
					<option value="500">Slow</option>
					<option value="10">VideoGames</option>
					<option value="varied">Varied</option>
				</select>
				</li>
				<li>OCTAVE
				<select id="octave">
					<option value="0">0</option>
					<option value="12">12</option>
					</select>
				</li>
			</ul>
		</aside>
		<canvas id="audiocanvas" height="320px" width="320px"></canvas>

		<script type="text/javascript">
			context = new webkitAudioContext();
			osc = document.getElementById("sqr");
			console = document.getElementById("console");
			wave = document.getElementById("waveform");
			interval = document.getElementById("interval");
			onOff = document.getElementById("onOff");
			filter = document.getElementById("filter");
			speed = document.getElementById("speed");
			canvas = document.getElementById("audiocanvas");
			octave = document.getElementById("octave");

			var analyser = context.createAnalyser();
			var nodes = {};

			var ctx = canvas.getContext("2d");
		 
			var gradient = ctx.createLinearGradient(0,0,0,canvas.height);
			    gradient.addColorStop(1,'#550000');
			    gradient.addColorStop(0.75,'#ff0000');
			    gradient.addColorStop(0.25,'#ffff00');
			    gradient.addColorStop(0,'#ffff00');
			
			ctx.fillStyle = gradient;

			//add nodes
			nodes.filter = context.createBiquadFilter();  
			nodes.volume = context.createGainNode();
			nodes.delay = context.createDelayNode();
			nodes.feedbackGain = context.createGainNode();

			//connect it all
			nodes.filter.connect(nodes.volume);
			nodes.filter.connect(nodes.delay);
			nodes.delay.connect(nodes.feedbackGain);
			nodes.feedbackGain.connect(nodes.volume);
			nodes.feedbackGain.connect(nodes.delay);
			nodes.volume.connect(analyser);
			analyser.connect(context.destination);

			nodes.delay.delayTime.value = .212;
			nodes.feedbackGain.gain.value = .4;
			nodes.volume.gain.value = .5

			analyser.smoothingTimeConstant = 0.8;
			analyser.fftSize = 512;

			drawSpectrum();

			// array of all available frequencies
			var freqs = [65.406, 69.296, 73.416, 77.782, 82.407, 87.31, 92.50, 98.00, 103.83, 110.00, 116.54, 123.47, 130.81, 138.59, 146.83, 155.56, 164.81, 174.61, 185.00, 196.00, 207.65, 220.00, 233.08, 246.94, 261.63, 277.18, 293.67, 311.13, 329.63, 349.23, 369.99, 392.00, 415.30, 440, 466.16, 493.88, 523.25, 554.37, 587.33, 622.25, 659.26, 698.46, 739.99, 783.99, 830.61, 880.00, 932.33, 987.77, 1046.50, 1108.73, 1174.66, 1244.51, 1318.51, 1396.91, 1479.98, 1567.98, 1661.22, 1760.00, 1864.66, 1975.53, 2093.00];

			

			osc.onmousedown = function () 
			{
				// takes in an algorithmic value from the x and y location
				var locValue = Math.floor((window.event.clientX / (freqs.length * 1.8)) % freqs.length + parseInt(octave.value)); 
				var oscPitch = freqs[locValue];
				mouseLocation = window.event.clientX;
				oscillator = context.createOscillator();
				nodes.filter.type = parseInt(filter.value);
				oscillator.type = parseInt(wave.value);
				oscillator.frequency.value = oscPitch;
				setFilterFrequency();
				var direction = parseInt(interval.value);
				if (onOff.value === "true") {
					arp = setInterval(function() {
						// once you've gone out of bounds in the array, change direction until you're out of bounds again
						if(locValue + direction >= freqs.length || locValue + direction <= 0) {
							direction = -direction;
						}
						locValue += direction;
						createosc(locValue)
						setFilterFrequency();
					},setArpSpeed());
				} else {
					arp = setInterval(0,0);
				}
				oscillator.connect(nodes.filter);
				oscillator.noteOn(0);
				oscisrunning = true;
			};

			osc.onmousemove = function () 
			{
				if(oscisrunning) {
					setFilterFrequency();
					var xCurr = window.event.clientX;
					if((mouseLocation + 100) < xCurr || (mouseLocation - 100) > xCurr) {
						clearInterval(arp);
						mouseLocation = xCurr;
						var locValue = Math.floor((window.event.clientX / (freqs.length * 1.8)) % freqs.length + parseInt(octave.value));
						oscillator.frequency.value = freqs[locValue];
						var direction = parseInt(interval.value);
						if (onOff.value === "true") {
							arp = setInterval(function() {
								if(locValue + direction >= freqs.length || locValue + direction <= 0) {
									direction = -direction;
								}
								locValue += direction;
								createosc(locValue)
							},setArpSpeed());
						} else {
							arp = setInterval(0,0);
						}
					}	
					
				}
				
			};

			createosc = function (pitch)
			{
				oscillator.disconnect();
				oscillator = context.createOscillator(),
				oscillator.type = parseInt(wave.value);
				oscillator.frequency.value = freqs[pitch];
				oscillator.connect(nodes.filter)
				oscillator.noteOn(0);
			};

			osc.onmouseup = function () {
				turnOffOsc();
			};

			setFilterFrequency = function () {
	            var min = 40; // min 40Hz
	            var max = context.sampleRate / 2; // max half of the sampling rate
	            var numberOfOctaves = Math.log(max / min) / Math.LN2; // Logarithm (base 2) to compute how many octaves fall in the range.
	            var multiplier = Math.pow(2, numberOfOctaves * (((2 / (console.offsetTop + console.offsetHeight)) * ((console.offsetTop + console.offsetHeight) - window.event.clientY)) - 1.0)); // Compute a multiplier from 0 to 1 based on an exponential scale.
	            nodes.filter.frequency.value = max * multiplier; // Get back to the frequency value between min and max.
	            //sqr.innerText = max * multiplier;
        	};

        	setArpSpeed = function() {
        		if(speed === "varied") {
					return (((window.event.clientY / 100) * 50) + 100);
				} else {
					return parseInt(speed.value);
				}
        	}

        	function drawSpectrum() {
				var WIDTH = canvas.width,
					HEIGHT= canvas.height,
					array =  new Uint8Array(analyser.frequencyBinCount);
					
				analyser.getByteFrequencyData(array);
				ctx.clearRect(0, 0, WIDTH, HEIGHT);
				audioAnimation = requestAnimationFrame(drawSpectrum);
				
				for ( var i = 0; i < (array.length); i++ ){
					var value = array[i];
					ctx.fillRect(i*3,HEIGHT-value,2,HEIGHT);
				}
			}
			


			//console.onmouseout = function () {
			//	turnOffOsc();
			//};

		</script>
	</body>
</html>